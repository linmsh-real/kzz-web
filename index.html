<!DOCTYPE html>
<html>
<head>
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
		/* 默认样式（移动端优先） */
        table {
            border-collapse: collapse;
            /* width: 100%; */
			margin: 12px;
        }
  
		/* 电脑端样式（宽度768px以上） */
		@media (min-width: 768px) {
			table {
				/*width: 98%;  或者固定宽度如800px */
				/**居中*/
				margin-left: auto;
				margin-right: auto;
				font-size: 18px;
			}
		
			/* 涨幅榜最近几日出现的次数 */
			#changepercentNumber {
				/* width: 70%; */
			}
		}
        th, td {
            border: 1px solid #eee;
            padding: 8px;
            text-align: center;
			white-space: nowrap; /* 禁止换行 */
        }
		
        /* 为每列设置不同的背景色 */
		.thCol1 {background-color: #ff5555!important;}
		.thCol2 {background-color: rgb(255 192 0)!important;}
		.thCol3 {background-color: rgb(255 255 0)!important;}
		.thCol4 {background-color: rgb(0 176 80)!important;}
		.thCol5 {background-color: rgb(0 176 240)!important;}
        .col1 { background-color: rgb(220 228 234); }
        .col2 { background-color: rgb(248 202 171); }
		/* 奇数列样式 */
		.chartAll td:nth-child(odd), .chartAll th:nth-child(odd) {
			background-color: rgb(220 228 234); /* 浅蓝色#e6f7ff */
		}

		/* 偶数列样式 */
		.chartAll td:nth-child(even), .chartAll th:nth-child(even) {
			background-color: rgb(248 202 171); /* 浅橙色#fff2e6 */
		}
		
		/* 最近十天涨幅榜明细 */
		#changepercentRecently td:nth-child(1) {
			background-color: #eee;
			width:45px;
		}
		/* 最近十天涨幅榜明细-其他列设置相同宽度 */
		#changepercentRecently td:not(:nth-child(1)) {
			width:90px;
		}
    </style>
	<script type="text/javascript">
		$(document).ready(function(){
			//腾讯财经获取股票最近一个交易日
			getLatestTradingDay();
		});
		var amountDivisor = 100000000;
		//获取历史数据
		function getHistory(tradingTime){
			$.ajax({
				type: 'GET',
				url: 'https://gitee.com/api/v5/repos/linmsh/kzz-web/commits/e37099bb99c59b9b8a37ee5c113a949964846ce0/comments?page=1&per_page=20&access_token=20c88a9536f28ccced296370e0ed94e8',
				success: function(data,textStatus,jqXHR){
					var kzzData = JSON.parse(data[0].body), dataIndex = kzzData.length - 1;
						console.log("=kzzData=",kzzData)
					var latestData = kzzData[dataIndex];
					var historyTradingDay = latestData.tradingDay, historyTicktime = latestData.ticktime, tradingDay = parseInt(tradingTime.substring(0, 8)), ticktime = parseInt(tradingTime.substring(8, 14)), kzzDataLength = kzzData.length;
					var isSaveData = historyTradingDay < tradingDay || historyTicktime < ticktime;
					if(isSaveData) {
						//获取前20涨跌幅数据
						var changepercentData = getChangepercentData();
						//获取前20成交额排名及交易总额
						var amountData = getAmountData(), topData = amountData.topData, amountTotal = amountData.total;
						var changepercentSaveData = makeSaveData(changepercentData, 'changepercent'), amountSaveData = makeSaveData(topData, 'amount');
						var pushData = 	{
							"tradingDay":tradingDay,
							"ticktime":ticktime,
							"changepercentData":changepercentSaveData,
							"amountData":amountSaveData,
							"amountTotal":amountTotal
						}
						//把最近一个交易日的数据加入历史数据
						if(historyTradingDay == tradingDay) {
							kzzData[dataIndex] = pushData;
						} else {
							kzzData.push(pushData);
						}
						//超过存储容量，截取
						var maxLength = 20;
						if(kzzDataLength > maxLength) {
							kzzData = kzzData.slice(kzzDataLength - maxLength, kzzData.length);
						}
						kzzDataLength=kzzData.length;
					}
					//渲染涨跌幅和成交额
					makeAllData(kzzData, kzzDataLength);
					//渲染过去五/十个交易日该可转债上涨幅榜前20的次数
					makeChangepercentNumberData(kzzData, kzzDataLength);
					if(isSaveData) {
						//添加历史数据
						var dataString = JSON.stringify(kzzData);
						savaHistoryData(dataString);
					}
				},
				error: function(jqXHR,textStatus){
					console.log("请求失败，请稍后重试!");
				}
			});
		}
		//腾讯财经获取股票最近一个交易日
		function getLatestTradingDay() {
			$.ajax({
				type: 'GET',
				url: 'http://qt.gtimg.cn/q=sh601377',//sz123191
				success: function(data,textStatus,jqXHR){
					var dataArray = data.split('~');
					var tradingDay = dataArray[30];
					//获取历史数据
					getHistory(tradingDay);
				},
				error: function(jqXHR,textStatus){
					console.log("请求失败，请稍后重试!");
				}
			});
		}
		//获取前20涨跌幅数据
		function getChangepercentData() {
			console.log('======获取涨跌幅排名=======');
			var url = 'https://vip.stock.finance.sina.com.cn/quotes_service/api/json_v2.php/Market_Center.getHQNodeData'; 
			var param={
				page:1,
				num:20,
				sort:'changepercent',
				asc:0,
				node:'hskzz_z'
				//node:hs_z
				//date:2025-03-11
				//_s_r_a:init
			};
			var resultList = ajaxRequest(url, param);
			return resultList;
		}
		//获取前20成交额排名及交易总额
		function getAmountData() {
			var url = 'https://vip.stock.finance.sina.com.cn/quotes_service/api/json_v2.php/Market_Center.getHQNodeData';
			var result = {topData:[], total:0}, total=0, page=1;
			while(true) {
				console.log('======获取成交额排名排名,'+page+'=======');
				var param={
					page:page,
					num:100,
					sort:'amount',
					asc:0,
					node:'hskzz_z'
				}
				var resultList = ajaxRequest(url, param);
				if(page==1) {
					result.topData = resultList.slice(0, 20);
				}
				if(resultList.length < 100) {
					break;
				}
				for(var i=0; i<resultList.length; i++) {
					var data=resultList[i], amount=data.amount;
					total+=amount;
				}
				page++;
			}
			result.total = total;
			return result;
		}
		//添加历史数据
		function savaHistoryData(bodyData) {
			$.ajax({
				type: 'PATCH',
				url: 'https://gitee.com/api/v5/repos/linmsh/kzz-web/comments/39024058',
				data : {
					"access_token": "20c88a9536f28ccced296370e0ed94e8",
					"body": bodyData
				},
				//contentType: 'application/json; charset=utf-8',
				success: function(data,textStatus,jqXHR){
					console.log('==添加历史数据==', data);
				},
				error: function(jqXHR,textStatus){
					console.log("请求失败，请稍后重试!");
				}
			});
		}
		//构建保存数据
		function makeSaveData(sourceDatas, field) {
			var result=[];
			for(var i=0; i<sourceDatas.length; i++) {
				var data=sourceDatas[i];
				//topData[i].name = encodeURIComponent(name);//decodeURIComponent
				var saveData = {
					name: data.name,
				}
				saveData[field] = data[field];
				result.push(saveData);
			}
			return result;
		}
		//渲染涨跌幅和成交额
		function makeAllData(kzzDatas, kzzDataLength) {
			var maxLength = 5, startIndex=0, thColNumber=0;
			if(kzzDataLength > maxLength) {
				startIndex=kzzDataLength - maxLength;
			}
			var headContent = '<tr>\n', secContent = '<tr>\n', dataContent=[];
			for(var i=startIndex; i<kzzDataLength; i++) {
				var data=kzzDatas[i], tradingDay = data.tradingDay+'', amountTotal = data.amountTotal, 
				changepercentData=data.changepercentData, amountData=data.amountData;
				amountTotal = amountTotal/amountDivisor;
				amountTotal = Math.round(amountTotal);
				headContent += '<th colspan="2" class="thCol'+(thColNumber++)+'">' + parseInt(tradingDay.substring(4, 6)) + '-' + tradingDay.substring(6, 8) + '（'+amountTotal+'亿元）</th>\n';
				secContent +='<td class="col1">涨幅（%）</td>\n<td class="col2">成交（亿）</td>\n';
				for(var j=0; j<changepercentData.length; j++) {
					var changepercent = Math.round(changepercentData[j].changepercent);
					var amount = amountData[j].amount;
					amount = amount/amountDivisor;
					amount = Math.round(amount);
					var currDataContent = i==startIndex?'':dataContent[j];
					if(i==startIndex) {
						currDataContent += '<tr>\n'; 
					}
					currDataContent += '<td>'+formateName(changepercentData[j].name)+changepercent+'</td>\n'; 
					currDataContent += '<td>'+formateName(amountData[j].name)+amount+'</td>\n';
					if(i==kzzDataLength-1) {
						currDataContent += '</tr>\n'; 
					}
					if(i==startIndex) {
						dataContent.push(currDataContent);
					} else {
						dataContent[j]=currDataContent;
					}
				}
			}
			headContent += '</tr>';
			secContent += '</tr>';
			$('.chartAll').html(headContent + secContent + dataContent.join(''));
		}
		//渲染过去五/十个交易日该可转债上涨幅榜前20的次数
		function makeChangepercentNumberData(kzzDatas, kzzDataLength) {
			var maxLength = 10, startIndex=0, top5={}, top10={}, chaNumberContent='', chaRecentlyContent='', dataContent = [];
			if(kzzDataLength > maxLength) {
				startIndex=kzzDataLength - maxLength;
			}
			for(var i=kzzDataLength-1; i>=startIndex; i--) {
			//for(var i=startIndex; i<kzzDataLength; i++) {
				var data=kzzDatas[i], tradingDay = data.tradingDay+'', changepercentData=data.changepercentData;
				for(var j=0; j<changepercentData.length; j++) {
					var name = changepercentData[j].name;
					if(i >= kzzDataLength - 5) {
						top5[name] = (top5[name] || 0) + 1;
					}
					top10[name] = (top10[name] || 0) + 1;
					//组织历史可转债数据
					var currDataContent = i==(kzzDataLength-1)?'':dataContent[j];
					if(i==kzzDataLength-1) {
						currDataContent += '<tr>\n'; 
						currDataContent += '<td>榜'+(j+1)+'</td>\n'; 
					}
					currDataContent += '<td>'+changepercentData[j].name+'</td>\n'; 
					if(i==startIndex) {
						currDataContent += '</tr>\n'; 
					}
					if(i==kzzDataLength-1) {
						dataContent.push(currDataContent);
					} else {
						dataContent[j]=currDataContent;
					}
				}
				//尾部日期
				chaRecentlyContent += '<td>'+parseInt(tradingDay.substring(4, 6)) + '.' + tradingDay.substring(6, 8)+'</td>\n';
				if(i==startIndex) {
					chaRecentlyContent=dataContent.join('') + '<tr style="background-color: rgb(220 228 234);">\n<td>日期</td>\n'+chaRecentlyContent+'</tr>\n';
				}
			}
			
			var top5Sort = sortData(top5);
			console.log('==top5==', top5Sort);
			var top10Sort = sortData(top10);
			console.log('==top10==', top10Sort);
			//渲染涨幅榜前20的次数
			var latestDatas = kzzDatas[kzzDataLength - 1], tradingDay=latestDatas.tradingDay+'', changepercentData=latestDatas.changepercentData, 
			date=parseInt(tradingDay.substring(4, 6)) + '.' + tradingDay.substring(6, 8);
			console.log('=latestDatas=', latestDatas);
			maxLength = Math.max(top5Sort.length, top10Sort.length, changepercentData.length);
			$("#latestDate").html(date+'前20');
			for(var i=0; i<maxLength; i++) {
				chaNumberContent+='<tr>\n';
				if(top5Sort.length > i) {
					chaNumberContent+='<td>'+top5Sort[i].key+'</td><td>'+top5Sort[i].value+'</td>\n';
				} else {
					chaNumberContent+='<td></td><td></td>\n';
				}
				if(top10Sort.length > i) {
					chaNumberContent+='<td>'+top10Sort[i].key+'</td><td>'+top10Sort[i].value+'</td>\n';
				} else {
					chaNumberContent+='<td></td><td></td>\n';
				}
				if(changepercentData.length > i) {
					chaNumberContent+='<td>'+changepercentData[i].name+'</td>\n';
				} else {
					chaNumberContent+='<td></td>\n';
				}
				chaNumberContent+='</tr>\n';
			}
			$('#changepercentNumber').append(chaNumberContent);
			$('#changepercentRecently').html(chaRecentlyContent);
		}
		//格式化name
		function formateName(name) {
			if(name.indexOf('转债') == name.length - 2) {
				name = name.substring(0, name.length-2);
			} else if(name.indexOf('转') == name.length - 1) {
				name = name.substring(0, name.length-1);
			}
			if(endsWithNumber(name)) {
				name += ' ';
			}
			return name;
		}
		function endsWithNumber(str) {
			return /\d$/.test(str);
		}
		function sortData(data) {
			console.log('=排序过滤前数据=', data);
			const sortedArray = Object.entries(data)
			   .filter(([key, value]) => value !== 1)  // 过滤掉 value === 1
			  .sort((a, b) => b[1] - a[1]) // 降序排序
			  .map(([key, value]) => ({ key, value }));
			  return sortedArray;
		}
		//ajax公共方法
		function ajaxRequest(url, param) {
			var htmlobj=$.ajax({
				url:url,
				data:param,
				async:false,
				error: function(jqXHR,textStatus){
					alert("请求失败，请稍后重试!");
				}
			});
			try {
				var result=JSON.parse(htmlobj.responseText);
				return result;
			} catch(e) {
				alert(e);
			}
			return null;
		}
	</script>
</head>
<body>

<table class="chartAll">
</table>

<br>
<table id="changepercentNumber">
    <tr>
        <th colspan="5" style="background-color: #eee;">过去五/十个交易日该可转债上涨幅榜前20的次数</th>
    </tr>
    
    <tr>
        <td>可转债</td>
        <td>五日次数</td>
        <td>可转债</td>
        <td>十日次数</td>
        <td id="latestDate">3.21前20</td>
    </tr>
</table>

<br>
<table id="changepercentRecently">
</table>

</body>
</html>